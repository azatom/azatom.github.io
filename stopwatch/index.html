<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0">
    <title>Stopwatch</title>
    <style>
        html,
        body,
        body>div {
            height: 100%;
        }

        body>div,
        span {
            background-color: #fff;
        }

        body>div>div:first-child {
            font-size: 1.6rem;
        }

        body>div:empty:after {
            content: 'tap on white or press any key';
            color: #aaa;
        }

        body {
            margin: 0;
            user-select: none;
            overflow: hidden;
            font-family: monospace;
            font-size: 1.2rem;
            background-color: #e7f0e7;
        }

        span {
            display: inline-block;
            border-radius: .3rem;
            margin: .5rem;
        }
    </style>
    <script>
        function padLeft(width, value) {
            return String(value).padStart(width, "0");
        }
        function handleCopyClick(event) {
            navigator.clipboard.writeText(domLaps.innerText).then(function () {
                event.target.innerText = 'COPIED';
                setTimeout(function () { event.target.innerText = 'copy'; }, 1400);
            }).catch(function () { });
        }
        function addLapRow(text) {
            if (text) domLapRow.textContent = text;
            domLaps.prepend(domLapRow = document.createElement("div"));
        }
        function updateTimerDisplay() {
            let nowTime = Date.now();
            domLapRow.textContent = formatTime(nowTime - start) + " " + formatTime(nowTime - now);
            window.requestAnimationFrame(updateTimerDisplay);
        }
        function formatTime(ms) {
            let msPart = Math.floor(ms % 1e3),
                sec = Math.floor(ms / 1e3 % 60),
                min = Math.floor(ms / 6e4 % 60);
            return " " + (padLeft(2, Math.floor(ms / 36e5))
                + ":" + padLeft(2, min)
                + ":" + padLeft(2, sec)
                + "." + padLeft(3, msPart)).replace(/^[0:]+([0-9])/, "$1");
        }
        function resetStopwatch() {
            last = start = now = Date.now();
            sum2 = laps = 0;
            domLaps.replaceChildren();
        }
        function handleLap(event) {
            last = now;
            now = Date.now();
            if (laps) {
                let elapsed = now - start;
                let avg = elapsed / laps;
                let lapTime = now - last;
                sum2 += lapTime * lapTime;
                addLapRow(
                    String(laps)
                    + formatTime(elapsed)
                    + formatTime(lapTime)
                    + formatTime(avg)
                    + formatTime(laps ? Math.sqrt(sum2 / laps - avg * avg) : 0)
                    + " " + (event.code || "mouse" + event.button)
                );
            } else {
                resetStopwatch();
                addLapRow();
                addLapRow(new Date().toJSON());
                addLapRow("# clock laptime avg stddev key");
                window.requestAnimationFrame(updateTimerDisplay);
            }
            laps++;
        }
        function buildUI() {
            domCopyBtn = document.createElement("span");
            domResetBtn = document.createElement("span");
            domLaps = document.createElement("div");
            domResetBtn.innerText = "reset";
            domCopyBtn.innerText = "copy";
            domResetBtn.onclick = resetStopwatch;
            domCopyBtn.onclick = handleCopyClick;
            document.body.prepend(domLaps);
            document.body.prepend(domCopyBtn);
            document.body.prepend(domResetBtn);
            document.body.addEventListener("keydown", handleLap);
            domLaps.addEventListener("pointerdown", handleLap);
        }
        function saveState() {
            localStorage.setItem("sw_state", JSON.stringify({
                start, now, last, sum2, laps, content: domLaps ? domLaps.innerHTML : ""
            }));
        }
        function loadState() {
            var state = localStorage.getItem("sw_state");
            buildUI();
            if (!state) return;
            try {
                let content;
                ({start, now, last, sum2, laps, content} = JSON.parse(state));
                if (content) domLaps.innerHTML = content;
                domLapRow = domLaps.firstChild;
                if (laps > 0 && domLapRow) window.requestAnimationFrame(updateTimerDisplay);
            } catch (e) { }
        }
        function setupApp() {
            window.addEventListener('load', function () {
                if (navigator && navigator.serviceWorker) {
                    navigator.serviceWorker.register('./sw.js').catch(function (e) { });
                }
            });
            document.addEventListener('DOMContentLoaded', loadState);
            window.addEventListener('beforeunload', saveState);
        }

        let domCopyBtn, domResetBtn, domLaps, domLapRow;
        let start, now, last, sum2, laps;
        setupApp();
    </script>
</head>

<body>
</body>

</html>
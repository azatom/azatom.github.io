<!DOCTYPE html>
<html dir="ltr" lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>L-System Fractals</title>
  <script src="lsystem.js"></script>
  <script src="lsystem.examples.js"></script>
  <!--script async src="https://cdn.jsdelivr.net/npm/marked@16/lib/marked.umd.js"></script-->
  <style>
    .dont object,
    .dont svg,
    /*.dont button,
    .dont .dividerv,
    .dont #log,*/
    .dont img {
      filter: url('data:image/svg+xml,\
    <svg xmlns="http://www.w3.org/2000/svg">\
      <filter id="waves" x="-20%" y="-20%" width="140%" height="140%" \
      filterUnits="objectBoundingBox" primitiveUnits="userSpaceOnUse" \
      color-interpolation-filters="linearRGB">\
        <feTurbulence type="turbulence" baseFrequency="0.03 0.03" numOctaves="3" \
        seed="1" stitchTiles="noStitch" result="turbulence" />\
        <feDisplacementMap in="SourceGraphic" in2="turbulence" scale="5" \
        xChannelSelector="G" yChannelSelector="A" result="displacementMap" />\
        <feGaussianBlur stdDeviation=".15" />\
      </filter>\
    </svg>#waves');
    }

    .dont .a,
    .dont .b {
      filter: none;
    }

    html {
      --o: #000;
      --oa: #000a;
      --d: #ddd;
      --e: #f5f5f5;
      --f: #fff;
      --fd: #fffd;
      --err: #d22;
      --font: system-ui, Arial, Helvetica, sans-serif;
      overflow: hidden;
      height: 100%;
      font-size: 1rem;
    }

    body {
      display: flex;
      flex-direction: row;
      overflow: hidden;
      background-color: var(--f);
      margin: 0;
      height: 100%;
      font-family: var(--font);
      line-height: 2;
    }

    #left {
      background-color: var(--f);
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      width: 24.5rem;
      max-width: 90vw;
      min-width: 3rem;
      position: relative;
      z-index: 1;
      height: auto;
    }

    .tpbg {
      background-image:
        repeating-linear-gradient(45deg, var(--f) 25%, transparent 25%, transparent 75%, var(--f) 75%, var(--f)),
        repeating-linear-gradient(45deg, var(--f) 25%, var(--e) 25%, var(--e) 75%, var(--f) 75%, var(--f));
      background-position: 0 0, 2rem 2rem;
      background-size: 4rem 4rem;
    }

    .buttons {
      display: grid;
      align-items: center;
      grid-template-columns: repeat(auto-fill, minmax(3.5rem, 1fr));
      gap: .5rem;
      user-select: none;
      padding: .5rem;
    }

    .buttons#export {
      padding-top: 0;
    }

    button {
      flex: 1;
      color: var(--o);
      border-radius: .3125rem;
      border: none;
      background-color: var(--e);
      line-height: 1;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .cursive button,
    .cursive #log {
      border: 1px solid var(--d);
      background-color: initial;
    }

    button:not([disabled]) {
      cursor: pointer;
    }

    button,
    button>object {
      height: 2.5rem;
    }

    button>object {
      pointer-events: none;
    }

    button:hover>.a,
    button>.b,
    button[data-checked]:hover>.b,
    button[data-checked]>.a {
      opacity: .2;
    }

    button:hover>.b,
    button>.a,
    button[data-checked]:hover>.a,
    button[data-checked]>.b {
      display: block;
      opacity: 1;
      position: absolute;
    }

    button[data-checked] {
      color: var(--d);
    }

    hr {
      border: none;
      border-top: .2rem solid var(--d);
      max-width: 9rem;
      margin: .2rem .5rem 0 .5rem;
    }

    #log {
      grid-column: 1 / -1;
      white-space: pre-wrap;
      flex-basis: auto;
      background-color: var(--e);
      transition: height .1s ease;
      overflow: hidden;
      height: 2.3rem;
      padding: .2rem;
      border-radius: .3125rem;
      line-height: 1.1;
      user-select: text;
      box-sizing: border-box;
    }

    #log:focus {
      height: 10rem;
      overflow: auto;
    }

    #textarea {
      height: 100%;
      font-family: monospace;
      box-sizing: border-box;
      padding: .5rem;
      white-space: pre-wrap;
      overflow: auto;
      border: none;
      min-height: 4rem;
      word-break: break-all;
      width: 100%;
    }

    #textarea>p {
      text-indent: -2.2ch;
      padding-left: 2.2ch;
      margin: .4rem 0;
      letter-spacing: .1ch;
      line-height: 1rem;
    }

    #textarea>p::first-letter {
      font-weight: 900;
    }

    .divider {
      height: initial;
      width: 0;
    }

    .dividerv {
      max-width: 0;
      margin: 0.5rem 0;
      padding: 0.25rem;
    }

    .dividerv:hover {
      cursor: col-resize;
    }

    .dividerh {
      height: 0;
    }

    .dividerh:hover {
      cursor: row-resize;
    }

    #right {
      display: flex;
      flex: 1;
      flex-direction: column;
      position: relative;
      overflow: auto;
      padding: 0;
      z-index: 0;
      width: 100%;
      height: 100%;
    }

    .col {
      justify-content: center;
    }

    .smallsvgs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(max(4rem, 15%), 1fr));
      width: 100%;
    }

    .smallsvgs svg {
      display: flex;
      overflow: hidden;
      aspect-ratio: 1;
    }

    .smallsvgs svg {
      cursor: pointer;
    }

    svg {
      height: auto;
      object-fit: contain;
      width: 100%;
      height: 100%;
      max-width: 100%;
      max-height: 100%;
    }

    #helpText {
      overflow: auto;
      line-height: 1;
      font-size: .9rem;
    }

    #helpModal {
      display: none;
      position: fixed;
      inset: 0;
      background: var(--oa);
      justify-content: center;
      align-items: center;
      z-index: 2;
    }

    #helpWindow {
      background: var(--f);
      padding: 1em;
      border-radius: 6px;
      box-shadow: 0 0 10px var(--oa);
      overflow: hidden;
    }

    #helpText {
      max-height: 80vh;
      max-width: 84ch;
    }

    pre {
      white-space: pre-wrap;
    }

    .preasdiv {
      white-space: normal;
      font-family: var(--font);
    }

    div[contenteditable="true"]:empty:not(:focus):before {
      display: block;
      font-family: var(--font);
      content: attr(data-placeholder);
      color: var(--oa);
      word-break: normal;
      line-height: 1.2;
    }

    .long-tap-progress {
      background: linear-gradient(90deg, var(--oa) 50%, var(--e) 50%);
      background-size: 400%;
      animation: slide .5s linear forwards;
    }

    @keyframes slide {
      to {
        background-position: 100%;
      }
    }

    .hidden {
      display: none !important;
    }

    .error {
      background: var(--e);
    }

    .svg-placeholder {
      width: 16.6%;
      height: 16.6%;
      background: var(--e);
      display: inline-block;
    }

    @media only screen and (max-width: 900px) {
      body {
        flex-direction: column;
      }

      #left {
        max-width: 100%;
        width: 100%;
      }

      .buttons {
        padding: .2rem;
        grid-template-columns: repeat(auto-fill, minmax(3.7rem, 1fr));
        gap: .2rem;
      }

      #textarea {
        padding: .2rem;
        resize: vertical;
        background: linear-gradient(135deg, var(--f) 98%, var(--d) 0);
      }

      #right {
        height: auto;
      }

      #divider1,
      body.keyboard-active .buttons,
      body.keyboard-active #log {
        display: none;
      }

      body.keyboard-active #left {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: 0 0;
        z-index: 2;
      }

      body.keyboard-active #textarea {
        background: var(--fd);
        position: relative;
        z-index: 3;
      }

      body.keyboard-active #right {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
      }
    }
  </style>
</head>

<body>
  <div id="left">
    <div class="buttons">
      <button id="buttonhelp" title="Help">?</button>
      <button id="buttonsubmit" title="Update (Ctrl+Enter)">
        <object data="lsystem.svg#S=+F++++F++++F,_a=30,_l=4,_cs=000f,_cb=0000,_p=3" tabindex="-1" class="a" type="image/svg+xml">Update</object>
        <div class="b">Update</div>
      </button>
      <button id="buttondot" title="Show endpoints only">
        <object data="lsystem.svg#S=++++++F++++F,_a=20,_cs=0000,_cb=0000,_l=3,_p=2,_d=1" tabindex="-1" class="a" type="image/svg+xml">:</object>
        <object data="lsystem.svg#S=++++++F++++F,_a=20,_cs=000f,_cb=0000,_l=9,_p=6" tabindex="-1" class="b" type="image/svg+xml">dots</object>
      </button>
      <button id="buttonnpp" title="CAREFUL! Above 9: type it">n--</button>
      <button id="buttontpbg" title="transparent">trans<br>parent</button>
      <button id="buttonnext" title="Shift: Previous example">next<br>exmpl</button>
      <button id="buttonall">
        <object data="lsystem.svg#S=[F]+S,_a=72,_cs=000f,_cb=0000,_n=5,_l=2,_p=3" tabindex="-1" class="a" type="image/svg+xml">all<br>exmpl</object>
        <div class="b">all<br>exmpls</div>
      </button>
      <button id="buttonlsclear">reset</button>
      <button id="buttondont" style="font-size:1.5rem">
        <div class="a">A</div>
        <div class="b cursive">S</div>
      </button>
      <button></button>
      <button></button>
      <button id="buttonexport">export</button>
      <div tabindex="0" id="log"></div>
      <button id="buttonjs" class="export hidden" title="Small, url .svg">
        <div class="a">url</div>
        <object data="lsystem.svg#S=++F++FF++FF++F++f---FF[+++F]---F,_a=45,_cs=000f,_cb=0000,_l=6,_p=4" tabindex="-1" class="b" type="image/svg+xml">url</object>
      </button>
      <button id="buttonsvg" class="export hidden" title="Download big, generated .svg">
        <div class="a">SVG</div>
        <object data="lsystem.svg#S=[A]!++++A,A=F++FF--F+++***F,_n=2,_m=1.4,_a=45,_cs=000f,_cb=0000,_l=3,_p=2" tabindex="-1" class="b" type="image/svg+xml">svg</object>
      </button>
      <button id="buttonpng" class="export hidden" title="Download as PNG">
        <div class="a">png</div>
        <object data="lsystem.svg#S=[A]!++++A,A=F++FF--F+++***F,_n=2,_m=1.4,_a=45,_cs=000f,_cb=0000,_l=3,_p=2" tabindex="-1" class="b" type="image/svg+xml">png</object>
      </button>
      <button id="buttonjson" class="export hidden">
        <div class="a">copy<br>json</div>
        <div class="b" style="font-size:2.2rem">{&nbsp;&nbsp;&nbsp;&nbsp;}</div>
      </button>
      <button id="buttonline" class="export hidden">
        <div class="a">copy<br>1-line</div>
        <div class="b" style="font-size:2.2rem">----</div>
      </button>
      <button id="buttonlines" class="export hidden">
        <div class="a">copy<br>lineS</div>
        <div class="b" style="font-size:2.2rem;text-align:left;line-height:.3">---<br>--<br>----<br></div>
      </button>
    </div>
    <div id="textarea" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
      data-placeholder=" Type here: S=S+F,_n=3 or click 'next'.&#xa; Reformat: Ctrl+Enter or Triangle (sorry edit is hectic).&#xa; Shift or LongTap reverses '++/--', 'next/prev'.&#xa; Autosave: localstorage.">
    </div>
  </div>
  <button class="divider dividerv" id="divider1"></button>
  <div id="right"></div>

  <div id="helpModal" onclick="event.target === this && helpClose()">
    <div id="helpWindow">
      <script>
        document.querySelector('#buttonhelp').addEventListener('click', help);
        async function help() {
          const $md = document.querySelector('.md');
          document.querySelector('#helpModal').style.display = 'flex';
          const renderMd = (t = 0) => {
            try {
              if (typeof marked !== 'undefined' && $md) {
                $md.innerHTML = marked.parse($md.innerText);
                $md.classList.remove('md');
                $md.classList.add('preasdiv');
              } else if (t < 1e4) setTimeout(() => renderMd(t * 1.5 + 100), t);
            } catch (e) { }
          };
          renderMd();
        };
        function helpClose() { document.querySelector('#helpModal').style.display = 'none'; }
        document.addEventListener('keydown', e => e.key === 'Escape' && helpClose());
      </script>
      <span onclick="helpClose()" style="float: right; cursor: pointer">X</span>
      <div id="helpText">
        <pre class="md">
# L-System Fractals
## Logo Turtle with Context-Free Grammar

### Important: If textarea behaves oddly (e.g., after pasting), use the Update (triangle) button.
  - No save! Use 'url' button to copy one-line ruleset or bookmark.
  - Buttons:
  - `?` - Show documentation
  - `&gt;` - Update rules and render
  - `dots` - Show endpoints only
  - `n--` - Shift or LongTap add iteration
  - `transparent` - ...
  - `*`, `next` - All/next examples
  - `reset` - localstorage+reload
  - `export`
    - `url` - Export rules as URL
    - `svg` - Download generated SVG
    - `png` - Download as PNG
    - `copy...` - to clipboard
- Generated SVG retains zoom and includes rules/stats in its description.

### How it Works:
Start with a sentence 'S'. Each iteration replaces
characters in the sentence using key-value rules.
The resulting sentence instructs a Logo turtle in
which direction, ho much go and draw or not its path.

### Syntax:
Rules can be in plaintext, URL fragment, query params, or JSON:
- Rules separated by `,` or `&` or `\n`
- Rule's key-value separated by `=` or `:`

### Rule's key-value pairs:
Keys starting with `_` are "string" rather then "chars", eg: number
- `_n`: Number of iterations
- `_l`: Initial line length (width=1)
- `_m`: Line length multiplier
- `_a`: Angle in degrees
- Single char: A rule
- Single char + `2`: One more iteration
- Empty key: Title

### Rule Value Characters:
- `S`: Starting sentence
- `F`, `f`: Move forward with/without drawing
- `+`, `-`, `^`, `|`: Rotate +a, -a, +90, 180
- `!`: Toggle rotation parity
- `*`, `/`: Multiply/divide line length by _m
- `[`, `]`: Push/pop position, length, direction
  note: empty stack pop leaves as is

### Additional parameters for svg:
- `_c...`: colors `none` or [0-9a-f]{3,8} w/o leading `#`
- `_x`, `_y`, `_w`, `_h`, `_p`: viewBox, padding
- `_d`: dot size
- `_cb`: rect fill, background
- `_cd`: circle fill, dot color
- `_cs`: path stroke, line color
- `_o`: stroke-opacity
- `_r`: blur

### Syntax
- Plaintext and url:
  - Rule separators: `,` or `&`. Plaintext: `\n` works too.
  - Key-value separator: `=`
- Url: preceed with `#` or `?` (fragment/queryparams)
- JSON: straightforward key-values

### Files
- `editor.html` - the "app" 
- `lsystem.svg`
  - embedable with `&lt;object>` or `&lt;embed>`, not with `&lt;img>`.
  - browser opens as standalone image with parameters
  - editable svg in urlbar
- `lsystem.js`
  - generates img capable plain svg
  - use in app
- `lsystem.examples.js`

### Some fibonacci:
```
f(0) = 0
f(n) = a*f(n-1)+b*f(n-2)
 x  a  b f(1)
 2  2 +1    2 
 3  4 -1    4 
 5  4 +1    4 
 6 10 -1    2 
 7 16 -1    3 
 8  6 -1    6 
10
x = i + round sqrt i ; A000037
```</pre>
      </div>
    </div>
  </div>

  <!--script type="module"-->
  <script type="module">
    const state = {
      cntUpdate: 0,
      cntSuccess: 0,
      egs: (typeof examples !== 'undefined' ? examples : ['S=f+f-fSF+FSF,_n=4']).map(s =>
        getRules(typeof s === 'string' ? s : stringify(s))
      ).filter(s => s),
      egsi: 0,
      isDividerActive: false,
      activeDivider: null,
      startX: 0,
      startY: 0,
      startWidth: 0,
      startHeight: 0,
      isMobileForce: 0,
      isMobile: function () { return state.isMobileForce === 0 ? state.isMobile0 : state.isMobileForce === 1; },
      isMobile0: /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
        typeof window.orientation !== 'undefined' ||
        (navigator.maxTouchPoints && navigator.maxTouchPoints > 1),
      lastViewportHeight: window.visualViewport ? window.visualViewport.height : window.innerHeight,
    };

    const el = {
      left: document.querySelector('#left'),
      textarea: document.querySelector('#textarea'),
      log: document.querySelector('#log'),
      divider1: document.querySelector('#divider1'),
      right: document.querySelector('#right'),
      buttDot: document.querySelector('#buttondot'),
      buttDont: document.querySelector('#buttondont'),
      buttSubmit: document.querySelector('#buttonsubmit'),
      buttNext: document.querySelector('#buttonnext'),
      message: Object.assign(document.createElement('div'), { style: 'font-size:2rem' }),
    };

    function setupEventListeners() {
      el.textarea.addEventListener('keydown', e => e.ctrlKey && e.key === 'Enter' && el.buttSubmit.click());
      el.textarea.addEventListener('input', e => update());
      el.textarea.addEventListener('blur', e => el.textarea.textContent === '' && (el.textarea.textContent = ''));
      el.textarea.addEventListener('paste', e => {
        e.preventDefault();
        let plainText = e.clipboardData.getData('text/plain');
        document.execCommand('insertText', false, plainText);
      });
      el.textarea.addEventListener('keydown', e =>
        e.ctrlKey && e.key === 'c' && !window.getSelection().toString().length && (
          e.preventDefault(),
          navigator.clipboard.writeText(stringify()),
          console.log('copied')
        )
      );
      ael('#buttonsubmit', e => update(getRules()));
      ael('#buttonnext', clickNext, 'altclick');
      ael('#buttonnpp', clickNpp, 'altclick');
      ael('#buttondot', toggleDot);
      ael('#buttondont', toggleDont);
      ael('#buttontpbg', toggleTpbg);
      ael('#buttonall', showAllExamples);
      ael('#buttonjs', e => openStandaloneSvg());
      ael('#buttonsvg', e => downloadSvg(getSvg()));
      ael('#buttonpng', async e => await downloadPng(getSvg()));
      ael('#buttonjson', e => (navigator.clipboard.writeText(JSON.stringify(getRules())), console.log('copied')));
      ael('#buttonline', e => (navigator.clipboard.writeText(stringify()), console.log('copied')));
      ael('#buttonlines', e => (navigator.clipboard.writeText(stringify().replace(/,/g, '\n')), console.log('copied')));
      ael('#buttonlsclear', e => { lsClear(); console.log('cleared'); location.reload(); });
      ael('#buttonexport', (e, s = !document.querySelector('#buttonexport').toggleAttribute('data-checked')) => document.querySelectorAll('.export').forEach(e => e.classList.toggle('hidden', s)));
    }

    function getSvg() { return el.right.querySelector(':scope svg'); }
    function openStandaloneSvg(o = getRules()) {
      Object.assign(
        document.createElement('a'), {
        target: '_blank',
        href: `lsystem.svg#${stringify(createR(getRules(), 1))}`,
      }).click();
    }

    function ael(elOrQs, lstnr, typ = 'click') {
      const el = typeof elOrQs === 'string' ? document.querySelector(elOrQs) : elOrQs;
      if (typ === 'altclick') {
        const alternative = (e, i) => lstnr(e, i || e.shiftKey || e.type === 'pointerdown');
        el.addEventListener('click', alternative, { passive: true });
        let isLongTap = false;
        const suppressPostLongClick = e => { if (isLongTap) { isLongTap = false; e.stopPropagation(); e.preventDefault(); } };
        el.addEventListener('click', suppressPostLongClick, { capture: true, passive: false });
        let longTapTimer = null;
        const startLongTap = e => {
          if (e.button && e.button !== 0) return;
          isLongTap = false;
          el.classList.add('long-tap-progress');
          longTapTimer = setTimeout(() => {
            isLongTap = true;
            alternative(e, -1);
            el.classList.remove('long-tap-progress');
          }, 500);
        };
        const cancelLongTap = e => {
          if (longTapTimer) { clearTimeout(longTapTimer); longTapTimer = null; }
          el.classList.remove('long-tap-progress');
        };
        el.addEventListener('pointerdown', startLongTap, { passive: true });
        el.addEventListener('pointerup', cancelLongTap, { passive: true });
        el.addEventListener('pointermove', cancelLongTap, { passive: true });
        el.addEventListener('pointercancel', cancelLongTap, { passive: true });
        el.addEventListener('pointerleave', cancelLongTap, { passive: true });
      } else {
        el.addEventListener(typ, lstnr, { passive: true });
      }
    }

    function clickNpp(e, i) {
      const R = getRules();
      R._n = Math.min(9, (i ? 1 : -1) + parseInt(R._n ?? 0));
      setText(R);
      update();
    }

    function clickNext(e, i) {
      i = i ? -1 : 1;
      i = (state.egsi + i) % state.egs.length;
      i = (i + state.egs.length) % state.egs.length;
      showExample(i);
    }

    function getText() {
      return el.textarea.innerText;
    }

    function sortKeys(a, b) {
      const p = p => p.replace(/^S/, ' S').replace(/^_/, 'zz');
      return a.length < b.length ? -1 : a.length > b.length ? 1 : p(a).localeCompare(p(b));
    }

    function stringify(rR = getRules(), isHtml) {
      return Object.keys(rR = 'string' == typeof rR ? getRules(rR) : rR)
        .sort(sortKeys)
        .map(k => isHtml ? `<p>${k}=${rR[k]}</p>` : `${k}=${rR[k]}`)
        .join(isHtml ? '' : ',');
    }

    function setText(rR) {
      el.textarea.innerHTML = stringify(rR, 1);
    }

    function getDot() {
      return el.buttDot.hasAttribute('data-checked');
    }

    function setDot(enabled) {
      el.buttDot.toggleAttribute('data-checked', enabled);
    }

    function getRules(s = getText()) {
      return Object.fromEntries(s
        .replace(/[\n\r&]+/g, ',')
        .replace(/(^[?#{}]|[}]$|[\r \t\s\u00A0]+)/g, '')
        .split(',')
        .filter(a => a !== '')
        .map(a => a.split(/[=:]/))
        .map(a => { if (a.length != 2) throw new Error('Format vaguelly:\nrules : (rule [\\n,&])*\nrule : key=value\nkey : (c | _c | c2)\nvalue : c*\nc : a char except eg.:   "&,=:"\nwhitespace ignored'); return a; })
        .map(a => a.map(a => a.replace(/(^"|"$)/g, '')))
        .map(([k, v]) => { if (!/^(|[^"]|_[^"]+|[^"]2)$/.test(k) && /[^"]*/.test(v)) throw new Error('Invalid format2'); return [k, v]; })
      );
    }

    function showError(msg) {
      el.message.innerText = msg || 'Processing2...';
      el.buttSubmit.classList.toggle('error', !!msg);
      el.right.replaceChildren(el.message);
    }

    function createR(o, preserveViewBox) {
      const R = typeof o === 'string' ? getRules(o) : o;
      const dot = getDot() ? { _cs: 'none', _d: 1 } : {};
      if (!preserveViewBox) return { ...R, ...dot };
      const vb = el.right.querySelector('svg');
      if (!vb) return { ...R, ...dot };
      const v = vb.getAttribute('viewBox')?.split(' ') || [];
      const rect = ['x', 'y', 'width', 'height'].map(attr =>
        vb.querySelector('rect')?.getAttribute(attr)
      );
      const vbObj = v.length && rect.join(' ') !== v.join(' ')
        ? { _x: v[0], _y: v[1], _w: v[2], _h: v[3] }
        : {};
      return { ...R, ...dot, ...vbObj };
    }

    function createIfAbsent(t, id, css) {
      return document.getElementById(id) ||
        document.body.appendChild(
          Object.assign(document.createElement(t), { id })
        );
    }

    function addSvgZoom(svg, parentSelector) {
      let isDown = false;
      let startX, startY, scrollStartX = 0, scrollStartY = 0;
      const rip = 'svgzoomr9fg34gs6h', $rect = createIfAbsent('div', `${rip}rect`);
      $rect.style = 'position:absolute;pointer-events:none;display:none;';
      createIfAbsent('style', `${rip}css`).sheet.insertRule(`${parentSelector} svg{cursor:zoom-out}`);
      const getXY = e => {
        const t = e.touches ? e.touches[0] || e.changedTouches[0] : e;
        return { x: t.pageX, y: t.pageY };
      };
      const start = e => {
        if (e.button) return;
        const p = getXY(e);
        startX = p.x;
        startY = p.y;
        scrollStartX = window.scrollX;
        scrollStartY = window.scrollY;
        isDown = true;
      };
      const move = e => {
        if (!isDown || e.button) return;
        const p = getXY(e);
        const out = p.x + window.scrollX - 2 < startX;
        $rect.style.cssText = `
          left:${Math.min(startX, p.x)}px;
          top:${Math.min(startY, p.y)}px;
          width:${Math.abs(p.x - startX)}px;
          height:${Math.abs(p.y - startY)}px;
          cursor:${out ? 'zoom-out' : 'zoom-in'};
          display:block;
          position:absolute;
          pointer-events:none;
          border:.2rem solid ${out ? '#e82' : '#17d'};
          background-color:${out ? '#e823' : '#17d3'};
        `;
      };
      const end = e => {
        if (!isDown) return;
        const p = getXY(e);
        const r = svg.getBoundingClientRect();
        const v = svg.getAttribute('viewBox').split(' ').map(parseFloat);
        const x1 = v[0] + (v[2] * (startX + scrollStartX - r.left)) / r.width;
        const y1 = v[1] + (v[3] * (startY + scrollStartY - r.top)) / r.height;
        const x2 = v[0] + (v[2] * (p.x + window.scrollX - r.left)) / r.width;
        const y2 = v[1] + (v[3] * (p.y + window.scrollY - r.top)) / r.height;
        svg.setAttribute('viewBox',
          p.x + window.scrollX - 2 < startX + scrollStartX
            ? `${v[0] - v[2]} ${v[1] - v[3]} ${3 * v[2]} ${3 * v[3]}`
            : `${x1} ${Math.min(y1, y2)} ${x2 - x1} ${Math.abs(y2 - y1)}`
        );
        isDown = false;
        $rect.style.display = 'none';
      };
      ['mousedown', 'touchstart'].forEach(e => svg.addEventListener(e, start, { passive: true }));
      ['mousemove', 'touchmove'].forEach(e => svg.addEventListener(e, move, { passive: true }));
      ['mouseup', 'touchend', 'touchcancel'].forEach(e => svg.addEventListener(e, end, { passive: true }));
      // ['pointerdown'].forEach((e) => svg.addEventListener(e, start), { passive: true });
      // ['pointermove'].forEach((e) => svg.addEventListener(e, move), { passive: true });
      // ['pointerup', 'pointercancel'].forEach((e) => svg.addEventListener(e, end), { passive: true });
      return svg;
    }

    const ls = 'lsystem_';
    function lsSave(R) {
      //localStorage.setItem(ls + 'tpbg', document.body.classList.contains('tpbg'));
      //localStorage.setItem(ls + 'egsi', state.egsi || 0);
      localStorage.setItem(ls + 'R', stringify(R));
    }
    function lsClear() {
      //localStorage.removeItem(ls + 'tpbg');
      //localStorage.removeItem(ls + 'egsi');
      localStorage.removeItem(ls + 'R');
    }
    async function localstorageLoad() {
      //document.body.classList.toggle('tpbg', localStorage.getItem(ls + 'tpbg') === 'true');
      //const egsi = localStorage.getItem(ls + 'egsi'); if (egsi) { state.egsi = Number(egsi); showExample(); }
      const r = localStorage.getItem(ls + 'R');
      if (r && r !== '' && r !== '{}') {
        await update(r);
      } else {
        await showAllExamples();
      }
    }

    async function update(rules) {
      state.cntUpdate++;
      let t = setTimeout(() => showError('Processing...'), 100);
      await new Promise(resolve => setTimeout(resolve, 0));
      try {
        if (rules) {
          rules = typeof rules === 'string' ? getRules(rules) : rules;
          setText(rules);
        } else {
          rules = getRules();
        }
        const R = createR(rules);
        const svg = await createSvg(R);
        clearTimeout(t);
        lsSave(rules);
        const stat = JSON.parse(svg.querySelector('desc').textContent).stat;
        console.log(Object.entries(stat).map(([k, v]) => v + ' ' + k).join(' '));
        addSvgZoom(svg, '#right');
        el.right.classList.add('col');
        el.right.replaceChildren(svg);
      } catch (err) {
        clearTimeout(t);
        showError(err.message);
      }
    }

    async function showExample(index = state.egsi) {
      state.egsi = (index + state.egs.length) % state.egs.length;
      await update(state.egs[state.egsi]);
      console.log(`[example: ${state.egsi + 1} / ${state.egs.length}]`);
    }

    function toggleTpbg() {
      const s = document.querySelector('#buttontpbg').toggleAttribute('data-checked');
      el.right.classList.toggle('tpbg', s);
      const R = getRules();
      s ? (R._cb = '0000') : (delete R._cb, 0);
      setText(R);
      update();
    }

    function toggleDot() {
      setDot(!getDot());
      getText() ? (setText({ ...getRules(), _d: getDot() ? 1 : 0, _cs: getDot() ? 'none' : '' }), update()) : showAllExamples();
    }

    function toggleDont(e) {
      const s = document.body.classList.toggle('dont');
      document.body.classList.toggle('cursive', s)
      e.target.toggleAttribute('data-checked', s);
    }
    function toggleMobile(e) {
      state.isMobileForce = state.isMobileForce ? 3 - state.isMobileForce : state.isMobile() ? 2 : 1;
      el.buttDont.textContent = state.isMobile() ? 'mobile' : 'desktop';
      document.body.classList.toggle('keyboard-active', !state.isMobile());
      init();
    }

    function showAllExamples() {
      setText('');
      if (1 || !el.smallsvgs) { // force because of dot
        el.smallsvgs = Object.assign(document.createElement('div'), { className: 'smallsvgs' });
        generateAllExamples(el.smallsvgs);
      }
      el.right.classList.remove('col');
      el.right.replaceChildren(el.smallsvgs);
    }

    async function generateAllExamples(container) {
      const t0 = performance.now();
      const eg2R = eg => Object.fromEntries(Object.entries(eg)
        .map(([k, v]) => [k, k === '_n' ? Math.max(2, parseInt(v) - 1, 1) : v])
      );
      const ael = r => {
        (r.svg).addEventListener('click', e => e.ctrlKey
          ? openStandaloneSvg(state.egs[state.egsi = r.i])
          : showExample(state.egsi = r.i)
        );
        return r.svg;
      };

      function svg2object(svg) {
        return Object.assign(Object.createElement('object'), { data: URL.createObjectURL(new Blob([new XMLSerializer().serializeToString(svg)], { type: 'image/svg+xml' })) });
      }

      /**/
      //slowfirst
      const promises = state.egs
        .map(async (eg, i) => ({ svg: await createSvg(createR(eg2R(eg))), i }));
      container.replaceChildren(...(await Promise.all(promises)).map(ael));
      /*/
      //slowlast
      for (const [i, eg] of state.egs.entries()) {
        const svg = await createSvg(createR(eg2R(eg)));
        const element = await ael({ svg, i });
        container.appendChild(element);
        await new Promise(resolve => setTimeout(resolve, 0));
      }
      /**/

      const overall = ((performance.now() - t0)).toFixed(0);
      const arr = [...container.querySelectorAll('svg')].map(a => JSON.parse(a.querySelector('desc').textContent).stat.ms);
      const sum = arr.reduce((p, c) => p + parseFloat(c), 0) | 0;
      const max = Math.max(...arr);
      const maxIdx = arr.indexOf(max);
      console.log(`[${state.egs.length} examples ${overall}ms ?${overall - sum}ms ${max}@${maxIdx + 1}]`);
    }

    async function downloadSvg(svg) {
      if (!svg) return;
      const serializer = new XMLSerializer();
      const xmlStr = serializer.serializeToString(svg);
      const uint8Array = new TextEncoder().encode(xmlStr);
      const blob = new Blob([uint8Array], { type: 'image/svg+xml' });
      const filename = `${svg.querySelector('title')?.textContent ?? 'untitled'}.svg`;
      await downloadBlob(blob, filename);
    }

    function ts(a) { return a >= 1e6 ? (a / 1e6).toFixed(6) : a; }

    async function downloadPng(svg) {
      let [x, y, w, h] = svg.getAttribute('viewBox').split(' ').map(parseFloat)
        , m = prompt('Larger size [px]? max safe 16384, def 3840');
      if (!svg || m === null) return;
      m = Number(m) || 3840;
      [w, h] = w < h ? [Math.ceil(m * w / h), m] : [m, Math.ceil(m * h / w)];
      try {
        const img = new Image()
          , canvas = document.createElement('canvas')
          , ctx = canvas.getContext('2d');
        img.src = 'data:image/svg+xml;base64,' + btoa(new XMLSerializer().serializeToString(svg));
        await new Promise(resolve => img.onload = resolve);
        ctx.drawImage(img, 0, 0, canvas.width = w, canvas.height = h);
        ctx.getImageData(0, 0, 1, 1);
        const blob = await new Promise((resolve, reject) => {
          canvas.toBlob(blob => blob ? resolve(blob) : reject(new Error('Blob creation failed')), 'image/png');
        });
        const filename = `${svg.querySelector('title')?.textContent ?? 'untitled'}.png`;
        await downloadBlob(blob, filename);
        console.log(`saved: ${w}x${h} ${ts(blob.size)} bytes ${filename}`);
      } catch (e) {
        showError(e + '\n' + w + "x" + h);
      }
    }

    async function downloadBlob(blob, filename) {
      let url;
      try {
        url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } catch (e) {
        showError(e.message);
      } finally {
        setTimeout(() => URL.revokeObjectURL(url), 100);
      }
    }

    function setupDividers() {
      el.divider1.addEventListener('pointerdown', e => {
        if (state.isMobile() && e.target === el.divider1) return;
        state.isDividerActive = true;
        state.activeDivider = e.target;
        state.startX = e.clientX;
        state.startY = e.clientY;
        state.startWidth = el.left.offsetWidth;
        state.startHeight = el.textarea.offsetHeight;
      }, { passive: true });
      window.addEventListener('pointerup', e => {
        state.isDividerActive = false;
        state.activeDivider = null;
      }, { passive: true });
      window.addEventListener('pointermove', e => {
        if (!state.isDividerActive || !state.activeDivider) return;
        if (state.activeDivider === el.divider1 && !state.isMobile()) {
          const deltaX = e.clientX - state.startX;
          const newWidth = state.startWidth + deltaX;
          el.left.style.width = `${Math.min(Math.max(newWidth, 50), window.innerWidth - 50)}px`;
        }
      }, { passive: true });
    }

    function setupMobileKeyboard() {
      if (!state.isMobile()) return;
      const updateRightSize = () => {
        if (document.body.classList.contains('keyboard-active') && window.visualViewport) {
          el.right.style.height = `${window.visualViewport.height}px`;
        } else {
          el.right.style.height = 'auto';
        }
      };
      el.textarea.addEventListener('focus', () => {
        document.body.classList.add('keyboard-active');
        updateRightSize();
      });
      el.textarea.addEventListener('blur', () => {
        document.body.classList.remove('keyboard-active');
        el.right.style.height = 'auto';
        el.left.style.background = 'transparent';
      });
      if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', () => {
          if (Math.abs(window.visualViewport.height - state.lastViewportHeight) > 50) {
            document.body.classList.toggle('keyboard-active', window.visualViewport.height < state.lastViewportHeight);
            updateRightSize();
            state.lastViewportHeight = window.visualViewport.height;
          }
        });
      }
    }

    function toggleCustomLog(enable, customLog, _ = console) {
      if (typeof customLog === 'function') {
        _.oldLog ??= _.log;
        _.customLog = customLog;
      }
      if (_.oldLog && _.customLog) {
        _.log = enable ? _.customLog : _.oldLog;
      }
    }

    function setupCustomLog() {
      toggleCustomLog(true, (...args) => {
        if (el.log) {
          el.log.replaceChildren(
            args.flatMap(a => a && 'object' == typeof a ? Object.entries(a) : [['', a]])
              .map(([k, v]) => `${k}${k && ' '}${String(v).replace(/-/g, '‑').replace(/Infinity/g, '-')}`)
              .join('\n')
            , document.createElement('br')
            , ...[...el.log.childNodes].slice(0, 9)
          );
        } else { console.oldLog(...args); }
      });
    }

    function setupDataurls() {
      [...document.querySelectorAll('[data-r]')].forEach(e => e.data = datasvg + '#' + e.getAttribute('data-r'));
    }
    function fromLocation(a = location.href.split(/[?#]/)[1]) {
      return a && (update(a), 1);
    }
    function load() {
      fromLocation() || localstorageLoad();
    }

    function init() {
      setupDataurls();
      setupCustomLog();
      setupDividers();
      setupMobileKeyboard();
      setupEventListeners();
      load();
      el.textarea.setAttribute('contenteditable', true);
    }

    window.addEventListener('hashchange', fromLocation);
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>

</html>
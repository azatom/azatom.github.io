<!doctype html>
<html dir="ltr" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>title</title>
    <script src="lsystem.svg.js"></script>
    <script src="svgZoom.js"></script>
    <script src="lsystem.examples.js"></script>
    <!--script async src="https://cdn.jsdelivr.net/npm/marked@16.4/lib/marked.umd.js"></script-->

    <style>
        html,
        body {
            margin: 0;
            height: 100%;
            display: flex;
            overflow: hidden;
            font-family: system-ui, sans-serif;
        }

        #left {
            display: flex;
            flex-direction: column;
            width: 20vw;
            min-width: 200px;
            max-width: 90vw;
            box-sizing: border-box;
            padding: 0.75rem;
            overflow: hidden;
        }

        #divider {
            width: 1px;
            padding: .4rem;
            background-color: #ccc;
            cursor: col-resize;
            background-clip: content-box;
        }

        #divider:hover {
            cursor: col-resize;
        }

        #right {
            flex: 1;
            display: flex;
            justify-content: center;
            overflow: auto;
            background: #fff;
        }

        textarea {
            width: 100%;
            height: 50%;
            resize: vertical;
            min-height: 4rem;
            max-height: 90vh;
            padding: 0.5rem;
            font-family: monospace;
            font-size: 1rem;
            box-sizing: border-box;
            border: none;
        }

        #butt {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: none;
            flex-wrap: wrap;
            margin: 0.5rem 0;
        }

        #butt button {
            padding: 0.35rem 0.75rem;
            border: 1px solid #aaa;
            border-radius: 4px;
            background: linear-gradient(to bottom, #fff, #eee);
            cursor: pointer;
            font-size: 0.9rem;
        }

        [onclick] {
            cursor: pointer;
        }

        #butt button:hover {
            background: linear-gradient(to bottom, #f6f6f6, #ddd);
        }

        #log {
            flex: 1;
            overflow: auto;
            background: #fff;
            padding: 0.5rem;
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
        }

        svg {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .smallsvgs>svg {
            width: 12.5%;
            height: 12.5%;
            cursor: pointer;
        }


        hr {
            border-top: 1px solid #ccc;
            max-width: 10rem;
            margin: auto .25rem;
        }

        .hidden {
            display: none;
        }

        .divaspre {
            white-space: pre;
            font-family: monospace;
            font-size: 1rem;
        }

        .preasdiv {
            white-space: normal;
            font-family: sans-serif;
        }


        input[type=checkbox] {
            display: inline-block;
            width: 2rem;
            position: relative;
            top: -.5rem;
            left: .5rem;
            margin-left: -0.6rem;
        }

        label {
            display: inline-block;
            width: 2em;
            margin-left: -2rem;
            padding-top: 1rem;
        }

        #helpModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
        }

        #helpWindow {
            background: white;
            padding: 1em;
            border-radius: 6px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            overflow: auto;
        }

        #helpText {
            max-height: 80vh;
            max-width: 84ch;
            font-size: 1rem;
            overflow: auto;
        }
    </style>
</head>

<body>
    <div id="left">
        <textarea placeholder="type here..."></textarea>
        <div id="butt">
            <button id="helpButton">?</button>
            <button onclick="update();">ctrl+enter</button>
            <button onclick="egsi=(egsi+egs.length-1)%egs.length;getEgsi();" title="examples">&lt;</button>
            <button onclick="egsi=(egsi+egs.length+1)%egs.length;getEgsi();" title="examples">&gt;</button>
            <input type="checkbox" id="dot" name="dot"><label for="dot">dot</label>
            <button onclick="smallsvgs();">âœ±</button>
        </div>
        <div id="log">..dragons..everywhere..</div>
    </div>
    <div id="divider"></div>
    <div id="right"></div>

    <script>
        let egs = typeof examples !== 'undefined' ? examples : [{
            S: 'AX',
            A: '[+AX-AX-AX]-AX+AX+AX-',
            F: '',
            X: 'F+F+F+FFF-F-F-F',
            _l: 2,
            _a: 60,
            _n: 3,
            '': 'tilesgLizard',
        }];
        addSvgZoom = typeof addSvgZoom !== 'undefined' ? addSvgZoom : () => { };
    </script>
    <script>
        const $textarea = document.querySelector('textarea');
        const $log = document.querySelector('#log');
        const $dot = document.querySelector('#dot');
        const $right = document.querySelector('#right');
        const $loading = document.createElement('span'); $loading.textContent = 'loading...';
        const $divider = document.getElementById('divider');
        const $left = document.querySelector('#left');

        let isResizing = false;

        $divider.addEventListener('mousedown', (e) => {
            e.preventDefault();
            isResizing = true;
            //document.body.style.cursor = 'col-resize';
        });

        window.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const newWidth = Math.min(Math.max(e.clientX, 200), window.innerWidth - 200);
            $left.style.width = newWidth + 'px';
        });

        window.addEventListener('mouseup', () => {
            isResizing = false;
            //document.body.style.cursor = '';
        });
        let $svg;
        const dot = i => i === undefined ? $dot.checked : $dot.checked = !i;
        let egsi = 0;
        let n = 2;
        let s2o = a => 'string' == typeof a ? JSON.parse(`{${a.replace(/&/g, ',').replace(/([^,=]*)=([^,=]*)/g, '"$1":"$2"')}}`) : a;
        egs = egs.map(s2o);
        let fromEgs = 0;
        let getEgsi = () => {
            fromEgs = 0;
            let R = egsi in egs ? egs[(fromEgs = 1, egsi)] : undefined;
            R = R ?? '';
            update(R);
        };
        let update = (s) => {
            if (undefined != s) {
                $textarea.value = typeof s == 'string' ? s.replace(/,/g, '\n')
                    : Object.entries(s).map(([k, v]) => k + '=' + v).join('\n');
            }
            $right.replaceChildren($loading);
            setTimeout(e => {
                const R = $textarea.value.replace(/[\n \t]+/g, ',').replace(/^,+|,+$/, '');
                const t0 = performance.now();
                try { $svg = createSvg(R, dot()); } catch (e) { }
                console.log(fromEgs ? 'Example ' + (egsi + 1) + ' of ' + egs.length : '(not saved)', (performance.now() - t0 | 0) + ' ms');
                fromEgs = 0;
                addSvgZoom($svg);
                $right.replaceChildren($svg);
            }, 0);
        };
        $dot.addEventListener('change', e => update());
        $textarea.addEventListener('keydown', e => e.ctrlKey && e.key == 'Enter' && update());
        $textarea.addEventListener('input', e => update());
        let keyListener = e => {
            switch (e.key) {
                case '.': dot(!dot); break;
                case '+': case 'ArrowRight': egsi = (egsi + egs.length + 1) % egs.length; break;
                case '-': egsi = (egsi + egs.length - 1) % egs.length; break;
                case '*': egs[egsi]['_n']++; break;
                case '/': egs[egsi]['_n'] = Math.max(0, egs[egsi]['_n'] - 1); break;
                default: return;
            }
            getEgsi();
        };
        console.oldlog = console.log;
        console.log = (...o) => {
            if (!$log) { console.oldlog(...o); return; }
            $log.prepend(document.createElement('hr'));
            $log.prepend(o.flatMap(o => 'object' == typeof o ? Object.entries(o) : [['', o]])
                .map(([k, v]) => `${k.padStart(3, ' ')} ${v}`).join('\n'));
        };
        //document.body.addEventListener('keydown', keyListener);
        //getEgsi();
        smallsvgs();

        function smallsvgs() {
            async function string2span(str, i, s = createSvg(str)) {
                // s.addEventListener('click', e => s.classList.toggle('big'));
                // s.addEventListener('click', e => location.href=`a.html#${str}`);
                s.addEventListener('click', e => update(str));
                return s;
            }
            (async () => {
                const $a = document.createElement('div');
                $a.classList.add('smallsvgs');
                $right.replaceChildren($a);
                for (let i = 0; i < egs.length; i++) {
                    $a.appendChild(await string2span(egs[i], i));
                    await new Promise(r => setTimeout(r, 0));
                }
            })();
        }
    </script>

    <div id="helpModal">
        <script>
            document.querySelector('#helpModal').onclick = e =>
                e.target === helpModal && (helpModal.style.display = 'none');
            document.querySelector('#helpButton').onclick = async e => {
                let a = document.querySelector('.md');
                document.querySelector('#helpModal').style.display = 'flex';
                const f = (t) => {
                    if (typeof marked != 'undefined' && a) {
                        a.innerHTML = marked.parse(a.innerText);
                        a.classList.remove('md');
                        a.classList.add('preasdiv');
                    } else if (t < 1e4) setTimeout(() => f(n - 1, t * 1.5 + 100), t);
                };
                f(0);
            }
        </script>
        <div id="helpWindow">
            <span onclick="document.querySelector('#helpModal').style.display='none'" style="float:right">X</span>
            <div id="helpText">
                <pre class="md">
##  Logo Turtle with Context Free grammar - L-System fractals

###  How it works:
Starting sentence is 'S'. In an iteration every character of the
sentence replaced by the key-value rule set. A key's default value is the
key itself. The resulted sentence says to the logo turtle what to do.

###  Parameter key - value pairs:
If key starts with `_`, than value is a number.
- `_n` - iterations
- `_l` - initial length of line (width=1)
- `_m` - multiply linelength
- `_a` - angle in degrees
- (1char) - a rule
- (empty) - title 
- (chars) - invalid, ContextSensitiveGrammar is not implemented

###  Characters of rule value:
- `S`: starting sentence
- `F`, `f`: forward with, without drawing a line
- `+`, `-`, `^`, `|`: rotate _a, -_a, right, straight
- `!`: change parity of rotation
- `*`, `/`: multiply, divide length of line with m
- `[`, `]`: store, load (position, length, direction)</pre>
            </div>
        </div>
    </div>
</body>

</html>
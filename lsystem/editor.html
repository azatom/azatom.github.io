<!DOCTYPE html>
<html dir="ltr" lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>L-System Fractals</title>
  <script src="lsystem.svg.js"></script>
  <script src="lsystem.examples.js"></script>
  <script async src="https://cdn.jsdelivr.net/npm/marked@16.4/lib/marked.umd.js"></script>
  <style>
    body {
      background-color: #fff;
      display: flex;
      margin: 0;
      font-family: system-ui, sans-serif;
      flex-direction: row;
    }

    #left {
      position: relative;
      display: flex;
      flex-direction: column;
    }

    #textarea,
    body,
    html {
      height: 100%;
    }

    #left,
    #textarea {
      box-sizing: border-box;
    }

    #log,
    #textarea {
      padding: 0.5rem;
      white-space: pre-wrap;
    }

    #log,
    #textarea {
      width: 100%;
    }

    #log,
    #textarea {
      font-family: monospace;
    }

    #helpText,
    #log,
    #textarea {
      overflow: auto;
    }

    #helpWindow,
    body,
    button,
    html {
      overflow: hidden;
    }

    #helpModal,
    .hidden {
      display: none;
    }

    button:hover>.a,
    button>.b,
    button[data-checked]:hover>.b,
    button[data-checked]>.a {
      /*display: none;*/
      opacity: .2;
      /*filter: invert(.5);*/
      position: absolute;
    }
    
    button:hover>.b,
    button>.a,
    button[data-checked]:hover>.a,
    button[data-checked]>.b {
      display: block;
      opacity: 1;
      /*filter: invert(.2);*/
      position: absolute;
    }

    #left {
      width: 16rem;
      min-width: 100px;
      max-width: 90vw;
      background-color: #eee7;
      z-index: 1;
      gap: 0.5rem;
    }

    #right {
      display: flex;
      flex: 1;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: auto;
      padding: 0;
      z-index: 0;
      width: 100%;
      height: 100%;
    }

    .smallsvgs {
      width: 100%;
      height: 100%;
      align-items: flex-start;
      justify-content: flex-start;
      display: flex;
      flex-wrap: wrap;
      flex-direction: row;
      align-content: flex-start;
    }

    .smallsvgs>svg {
      width: calc(min(12.2vh, 12.2vw) - 2px);
      height: calc(min(12.2vh, 12.2vw) - 2px);
      cursor: pointer;
    }

    #textarea {
      resize: vertical;
      border: none;
      background: linear-gradient(135deg, #fff 0, #fff 99%, #a6a6a6 95%);
      min-height: 4rem;
      font-size: 1rem;
      word-break: break-all;
    }

    #helpText,
    #log {
      font-size: 0.9rem;
    }

    #textarea>p {
      text-indent: -3.3ch;
      padding-left: 3.3ch;
      margin: 0.4rem 0;
      letter-spacing: 0.1ch;
      line-height: 1rem;
    }

    #textarea>p::first-letter {
      font-weight: 900;
      font-style: italic;
    }

    #log {
      flex: 1;
      height: 9rem;
      flex-basis: auto;
    }

    svg {
      width: 100%;
      height: 100%;
      object-fit: contain;
      max-width: 100%;
      max-height: 100%;
    }


    #butt {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.5rem;
      user-select: none;
      padding: 0 0.3rem 0.5rem 0.5rem;
      flex: none;
    }

    button>object {
      pointer-events: none;
    }

    button,
    button>object {
      height: 2.1rem;
      width: 2.1rem;
    }

    button {
      color: #000;
      font-size: 1.2rem;
      border-radius: 0.3125rem;
      cursor: pointer;
      border: none;
      background-color: #ddd;
      line-height: 1;
      padding: 0;
      font-family: sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    button:hover {
      background-color: #acf;
    }

    button.off {
      color: #aaa;
    }

    button>.b {
      font-size: 2rem;
    }


    .divider {
      padding: 0.3rem;
      background-clip: content-box;
    }

    .dividerv {
      width: 0;
      background: linear-gradient(to right, #f5f5f5 0, #f5f5f5 50%, #fff 50%, #fff 100%);
    }

    .dividerv:hover {
      cursor: col-resize;
    }

    .dividerh {
      height: 0;
    }

    .dividerh:hover {
      cursor: row-resize;
    }

    #helpModal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
      z-index: 2;
    }

    #helpWindow {
      background: #fff;
      padding: 1em;
      border-radius: 6px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
    }

    #helpText {
      max-height: 80vh;
      max-width: 84ch;
    }

    hr {
      border: none;
      border-top: 0.5px solid #ccc;
      max-width: 10rem;
      margin: 0 0.25rem;
    }

    .error {
      background: #d22;
    }

    .preasdiv {
      white-space: normal;
      font-family: sans-serif;
    }

    div[contentEditable="true"]:empty:not(:focus):before {
      font-family: sans-serif;
      font-size: 1rem;
      content: attr(data-placeholder);
      color: #777;
    }

    @media only screen and (max-width: 600px) {

      body,
      html {
        flex-direction: column;
      }

      #left,
      #right {
        width: 100%;
        height: auto;
      }

      #left {
        max-width: 100%;
        padding: 0;
        gap: 0;
      }

      #butt,
      #log,
      #textarea {
        padding: 0.2rem;
      }

      #butt {
        margin: 0;
        gap: 0.2rem;
      }

      #textarea {
        height: 30vh;
      }

      #log {
        max-height: 9rem;
      }

      #right {
        flex: 1;
      }

      #divider1,
      body.keyboard-active #butt,
      body.keyboard-active #log {
        display: none;
      }

      body.keyboard-active #left {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: 0 0;
        z-index: 2;
      }

      body.keyboard-active #textarea {
        background: rgba(255, 255, 255, 0.9);
        position: relative;
        z-index: 3;
      }

      body.keyboard-active #right {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
      }
    }
  </style>
</head>

<body>
  <div id="left">
    <div id="textarea" contenteditable="true" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-placeholder="Type here S=FS+SF,_n=2&#xa;Click around:&#xa; ? - if it helps&#xa;▶ - redraws (eg. autozoom)&#xa; &lt;> - prev/next example&#xa; dot - ...&#xa; * - all examples&#xa; url - small svg&#xa; svg - generated large svg&#xa; png - TBD&#xa; log - just dragons"></div>
    <div id="butt">
      <button id="helpButton" title="Help">?</button>
      <button id="buttonsubmit" title="Update (Ctrl+Enter)">▶</button>
      <button id="prevExample" title="Previous example">&lt;</button>
      <button id="nextExample" title="Next example">&gt;</button>
      <button id="dot" title="Show endpoints only">
        <object class="a" type="image/svg+xml" data="lsystem.js.svg?S=+++F++++F,_a=20,_b=0000,_l=2,_M=1,_d=1">●</object>
        <object class="b" type="image/svg+xml" data="lsystem.js.svg?S=+++F++++F,_a=20,_b=0000,_l=8,_M=4">l</object>
      </button>
      <button id="allExamples" title="Show all examples">✱</button>
      <button id="openStandalone" title="Small, url .svg">
        <div class="a">url</div>
        <object class="b" type="image/svg+xml" data="lsystem.js.svg?S=++F++FF++FF++F++f---FF[+++F]---F,_a=45,_b=0000,_l=6,_M=4">㏒</object>
      </button>
      <button id="downloadSvg" title="Download big, generated .svg">
        <div class="a">svg</div>
        <object class="b" type="image/svg+xml" data="lsystem.js.svg?S=F++*F/--/F+++*FF++FF/+++F--**F++F,_m=1.41,_a=45,_b=0000,_l=3,_M=2">l</object>
      </button>
      <button id="downloadPng" title="TODO">
        <div class="a">png</div>
        <object class="b" type="image/svg+xml" data="lsystem.js.svg?S=F++*F/--/F+++*FF++FF/+++F--**F++F,_m=1.41,_a=45,_b=0000,_l=3,_M=2">l</object>
      </button>
      <button id="buttonlog" title="Toggle log">
        <div class="a">log</div>
        <object class="b" type="image/svg+xml" data="lsystem.js.svg?A=[+AX-AX-AX]-AX+AX+AX-,F=,S=AX,X=F+F+F+FFF-F-F-F,_a=60,_m=1.5,_n=3,_b=0000,_l=4,_M=2">㏒</object>
      </button>
      <div id="log"></div>
    </div>
  </div>
  <div class="divider dividerv" id="divider1"></div>
  <div id="right"></div>

  <div id="helpModal">
    <div id="helpWindow">
      <span onclick="document.querySelector('#helpModal').style.display='none'" style="float: right; cursor: pointer">X</span>
      <div id="helpText">
        <pre class="md">
## Logo Turtle with Context-Free Grammar - L-System Fractals

### How it Works:
Start with a sentence 'S'. Each iteration replaces
characters in the sentence using key-value rules.
The resulting sentence instructs a Logo turtle in
which direction, ho much go and draw or not its path.

### Syntax:
As ruleset can be in url fragment, queryparam, json
or plaintext:
- Rules separated by `,` or `&` or `\n`
- Rule's key-value separated by `=` or `:`

### Rule's key-value pairs:
Keys starting with `_` have numeric values:
- `_n`: Number of iterations
- `_l`: Initial line length (width=1)
- `_m`: Line length multiplier
- `_a`: Angle in degrees
- Single char: A rule
- Single char + `2`: Rule for n+1 iteration
- Empty key: Title

### Rule Value Characters:
- `S`: Starting sentence
- `F`, `f`: Move forward with/without drawing
- `+`, `-`, `^`, `|`: Rotate +a, -a, +90, 180
- `!`: Toggle rotation parity
- `*`, `/`: Multiply/divide line length by _m
- `[`, `]`: Push/pop position, length, direction

### Syntax
- Plaintext and url:
  - Rule separators: `,` or `&`. Plaintext: `\n` works too.
  - Key-value separator: `=`
- Url: preceed with `#` or `?` (fragment/queryparams)
- JSON: straightforward key-values

### Files
2 same versions: vaguelly first 2 lines, script/svg tag swapped.
- `lsystem.js.svg`
  - embedable with `&lt;object>` or `&lt;embed>`, not with `&lt;img>`.
  - browser opens as standalone image with parameters
  - editable in urlbar
- `lsystem.svg.js`
  - generates img capable plain svg

### Some fibonacci:
```
f(0) = 0
f(n) = a*f(n-1)+b*f(n-2)
 x  a  b f(1)
 2  2 +1    2 
 3  4 -1    4 
 5  4 +1    4 
 6 10 -1    2 
 7 16 -1    3 
 8  6 -1    6 
10
x ?= i + round sqrt i ; A000037
```</pre>
      </div>
    </div>
  </div>

  <script type="module">
    const state = {
      cnt: 0,
      cnt2: 0,
      examples: (typeof examples !== "undefined"
        ? examples
        : [
          {
            S: "AX",
            A: "[+AX-AX-AX]-AX+AX+AX-",
            F: "",
            X: "F+F+F+FFF-F-F-F",
            _l: 2,
            _a: 60,
            _n: 3,
            "": "tilesgLizard",
          },
        ]
      ).map((s) => (typeof s === "string" ? parseRules(s) : s)),
      currentExampleIndex: 0,
      isDividerActive: false,
      activeDivider: null,
      startX: 0,
      startY: 0,
      startWidth: 0,
      startHeight: 0,
      isMobile:
        /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
          navigator.userAgent
        ) ||
        typeof window.orientation !== "undefined" ||
        (navigator.maxTouchPoints && navigator.maxTouchPoints > 1),
      lastViewportHeight: window.visualViewport
        ? window.visualViewport.height
        : window.innerHeight,
    };

    const els = {
      textarea: document.querySelector("#textarea"),
      log: document.querySelector("#log"),
      dot: document.querySelector("#dot"),
      right: document.querySelector("#right"),
      left: document.querySelector("#left"),
      submit: document.querySelector("#buttonsubmit"),
      divider1: document.querySelector("#divider1"),
      helpModal: document.querySelector("#helpModal"),
      helpButton: document.querySelector("#helpButton"),
      prevExample: document.querySelector("#prevExample"),
      nextExample: document.querySelector("#nextExample"),
      allExamples: document.querySelector("#allExamples"),
      buttonlog: document.querySelector("#buttonlog"),
      openStandalone: document.querySelector("#openStandalone"),
      downloadSvg: document.querySelector("#downloadSvg"),
      downloadPng: document.querySelector("#downloadPng"),
      message: Object.assign(document.createElement("div"), {
        textContent: "generating...",
        style: "font-size:2rem",
      }),
    };

    els.helpModal.onclick = (e) =>
      e.target === els.helpModal && (els.helpModal.style.display = "none");
    els.helpButton.onclick = async () => {
      const $md = document.querySelector(".md");
      els.helpModal.style.display = "flex";
      const renderMd = (t = 0) => {
        try {
          if (typeof marked !== "undefined" && $md) {
            $md.innerHTML = marked.parse($md.innerText);
            $md.classList.remove("md");
            $md.classList.add("preasdiv");
          } else if (t < 1e4) setTimeout(() => renderMd(t * 1.5 + 100), t);
        } catch (e) { }
      };
      renderMd();
    };

    function stringify(o) {
      return Object.entries(o)
        .map(([k, v]) => `${k}=${v}`)
        .join(",");
    }

    function getText() {
      return els.textarea.innerText;
    }

    function setText(text) {
      els.textarea.innerText = text;
    }

    function setTextR(R) {
      els.textarea.innerHTML = Object.entries(R)
        .map(([k, v]) => `<p>${k.padStart(2, " ")}=${v}</p>`)
        .join("");
    }

    function getDot() {
      return els.dot.hasAttribute("data-checked");
    }

    function setDot(enabled) {
      els.dot.toggleAttribute("data-checked", enabled);
    }

    function parseRules(str) {
      return Object.fromEntries(
        str
          .replace(/&/g, ",")
          .replace(/([^,=]*)=([^,=]*)/g, "$1=$2")
          .split(",")
          .map((a) => a.split("="))
      );
    }

    function getRulesObj() {
      showError();
      const text = getText()
        .replace(/[\n&]+/g, ",")
        .replace(/[\r \t\s\u00A0]+/g, "")
        .split(",")
        .filter((s) => s !== "")
        .map((a) => a.split("="));
      if (
        !text.every(
          ([k, v]) => /^(|[^=,]|_[^=,]|[^=,]2)$/.test(k) && /[^=,]*/.test(v)
        )
      ) {
        showError("Invalid format");
        throw new Error("Invalid format");
      }
      return Object.fromEntries(text);
    }

    function showError(msg) {
      els.message.innerText = msg || "...";
      els.submit.classList.toggle("error", !!msg);
      msg && els.right.replaceChildren(els.message);
    }

    function createR(o, preserveViewBox) {
      const R = typeof o === "string" ? parseRules(o) : o;
      const dot = getDot() ? { _d: 1 } : {};
      if (!preserveViewBox) return { ...R, ...dot };
      const vb = els.right.querySelector("svg");
      if (!vb) return { ...R, ...dot };
      const v = vb.getAttribute("viewBox")?.split(" ") || [];
      const rect = ["x", "y", "width", "height"].map((attr) =>
        vb.querySelector("rect")?.getAttribute(attr)
      );
      const vbObj =
        v.length && rect.join(" ") !== v.join(" ")
          ? { _x: v[0], _y: v[1], _w: v[2], _h: v[3] }
          : {};
      return { ...R, ...dot, ...vbObj };
    }

    function createIfAbsent(t, id) {
      return (
        document.getElementById(id) ||
        document.body.appendChild(
          Object.assign(document.createElement(t), { id })
        )
      );
    }

    function addSvgZoom(svg) {
      let isDown = false;
      let startX, startY, scrollStartX = 0, scrollStartY = 0;
      const rip = "svgzoomr9fg34gs6h", $rect = createIfAbsent("div", `${rip}rect`);
      $rect.style = "position:absolute;pointer-events:none;display:none;";
      createIfAbsent("style", `${rip}css`).sheet.insertRule(`#${rip}rect>svg{cursor:zoom-out}`);
      const getXY = (e) => {
        const t = e.touches ? e.touches[0] || e.changedTouches[0] : e;
        return { x: t.pageX, y: t.pageY };
      };
      const start = (e) => {
        if (e.button) return;
        const p = getXY(e);
        startX = p.x;
        startY = p.y;
        scrollStartX = window.scrollX;
        scrollStartY = window.scrollY;
        isDown = true;
      };
      const move = (e) => {
        if (!isDown || e.button) return;
        const p = getXY(e);
        const out = p.x + window.scrollX - 2 < startX;
        $rect.style.cssText = `
          left:${Math.min(startX, p.x)}px;
          top:${Math.min(startY, p.y)}px;
          width:${Math.abs(p.x - startX)}px;
          height:${Math.abs(p.y - startY)}px;
          cursor:${out ? "zoom-out" : "zoom-in"};
          display:block;
          position:absolute;
          pointer-events:none;
          border:.2rem solid ${out ? "#e82" : "#17d"};
          background-color:${out ? "#e823" : "#17d3"};
        `;
      };
      const end = (e) => {
        if (!isDown) return;
        const p = getXY(e);
        const r = svg.getBoundingClientRect();
        const v = svg.getAttribute("viewBox").split(" ").map(parseFloat);
        const x1 = v[0] + (v[2] * (startX + scrollStartX - r.left)) / r.width;
        const y1 = v[1] + (v[3] * (startY + scrollStartY - r.top)) / r.height;
        const x2 = v[0] + (v[2] * (p.x + window.scrollX - r.left)) / r.width;
        const y2 = v[1] + (v[3] * (p.y + window.scrollY - r.top)) / r.height;
        svg.setAttribute("viewBox",
          p.x + window.scrollX - 2 < startX + scrollStartX
            ? `${v[0] - v[2]} ${v[1] - v[3]} ${3 * v[2]} ${3 * v[3]}`
            : `${x1} ${Math.min(y1, y2)} ${x2 - x1} ${Math.abs(y2 - y1)}`
        );
        isDown = false;
        $rect.style.display = "none";
      };
      ["mousedown", "touchstart"].forEach((e) => svg.addEventListener(e, start));
      ["mousemove", "touchmove"].forEach((e) => svg.addEventListener(e, move));
      ["mouseup", "touchend", "touchcancel"].forEach((e) => svg.addEventListener(e, end));
      return svg;
    }

    async function update(rules) {
      state.cnt++;
      if (rules) {
        setTextR(typeof rules === "string" ? parseRules(rules) : rules);
      }
      await new Promise((res) => setTimeout(res, 0));
      showError();
      try {
        const t0 = performance.now();
        const svg = createSvg(createR(getRulesObj()));
        console.log(
          `${state.cnt - ++state.cnt2}/${state.cnt} ${(performance.now() - t0) | 0
          }ms`
        );
        addSvgZoom(svg);
        els.right.replaceChildren(svg);
      } catch (err) {
        showError(err.message);
      }
    }

    async function showExample(index) {
      state.currentExampleIndex =
        (index + state.examples.length) % state.examples.length;
      await update(state.examples[state.currentExampleIndex]);
    }

    async function showAllExamples() {
      const container = Object.assign(document.createElement("div"), {
        className: "smallsvgs",
      });
      els.right.replaceChildren(container);

      for (let i = 0; i < state.examples.length; i++) {
        const R = Object.fromEntries(
          Object.entries(state.examples[i]).map(([k, v]) => [
            k,
            k === "_n" ? Math.max(2, v - 1) : v,
          ])
        );
        toggleCustomLog(false);
        const svg = createSvg(createR(R));
        console.log({ [`#${i}`]: state.examples[i]?.[""] || "" });
        toggleCustomLog(true);
        svg.addEventListener("click", (e) => {
          state.currentExampleIndex = i;
          if (e.shiftKey || e.ctrlKey) {
            openStandalone(state.examples[i]);
          } else {
            showExample(i);
          }
        });
        container.appendChild(svg);
        await new Promise((res) => setTimeout(res, 0));
      }
    }

    function openStandalone(o) {
      window
        .open(`lsystem.js.svg#${stringify(createR(o, 1))}`, "_blank")
        .focus();
    }

    async function downloadSvg(svg) {
      if (!svg) return;
      const serializer = new XMLSerializer();
      const xmlStr = serializer.serializeToString(svg);
      const uint8Array = new TextEncoder().encode(xmlStr);
      const blob = new Blob([uint8Array], { type: "image/svg+xml" });
      const filename = `${svg.querySelector("title")?.textContent ?? "untitled"
        }.svg`;
      await downloadBlob(blob, filename);
    }

    async function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      try {
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } finally {
        setTimeout(() => URL.revokeObjectURL(url), 100);
      }
    }

    async function downloadPng(svg) { }

    function setupDividers() {
      const setDividering = (e) => {
        if (state.isMobile && e.target === els.divider1) return;
        e.preventDefault();
        state.isDividerActive = true;
        state.activeDivider = e.target;
        state.startX = e.clientX;
        state.startY = e.clientY;
        state.startWidth = els.left.offsetWidth;
        state.startHeight = els.textarea.offsetHeight;
      };

      els.divider1.addEventListener("pointerdown", setDividering);

      window.addEventListener("pointerup", () => {
        state.isDividerActive = false;
        state.activeDivider = null;
      });

      window.addEventListener("pointermove", (e) => {
        if (!state.isDividerActive || !state.activeDivider) return;
        if (state.activeDivider === els.divider1 && !state.isMobile) {
          const deltaX = e.clientX - state.startX;
          const newWidth = state.startWidth + deltaX;
          els.left.style.width = `${Math.min(
            Math.max(newWidth, 50),
            window.innerWidth - 50
          )}px`;
        }
      });
    }

    function setupMobileKeyboard() {
      if (!state.isMobile) return;

      const updateRightSize = () => {
        if (
          document.body.classList.contains("keyboard-active") &&
          window.visualViewport
        ) {
          els.right.style.height = `${window.visualViewport.height}px`;
        } else {
          els.right.style.height = "auto";
        }
      };

      els.textarea.addEventListener("focus", () => {
        document.body.classList.add("keyboard-active");
        updateRightSize();
      });

      els.textarea.addEventListener("blur", () => {
        document.body.classList.remove("keyboard-active");
        els.right.style.height = "auto";
        els.left.style.background = "transparent";
      });

      if (window.visualViewport) {
        window.visualViewport.addEventListener("resize", () => {
          if (
            Math.abs(
              window.visualViewport.height - state.lastViewportHeight
            ) > 50
          ) {
            document.body.classList.toggle(
              "keyboard-active",
              window.visualViewport.height < state.lastViewportHeight
            );
            updateRightSize();
            state.lastViewportHeight = window.visualViewport.height;
          }
        });
      }
    }

    function toggleCustomLog(enable, customLog, _ = console) {
      if ("function" == typeof customLog) {
        _.oldLog ??= _.log;
        _.customLog = customLog;
      }
      if (_.oldLog && _.customLog) {
        _.log = enable ? _.customLog : _.oldLog;
      };
    }

    function setupCustomLog() {
      toggleCustomLog(true, (...args) => els.log?.prepend(args
        .flatMap((a) => typeof a === "object" ? Object.entries(a) : [["", a]])
        .map(([k, v]) => `${k.padStart(3, " ")} ${v}`)
        .join("\n"),
        document.createElement("hr")
      ) ?? console.oldLog(...args));
    }

    function setupEventListeners() {
      els.textarea.addEventListener(
        "keydown",
        (e) => e.ctrlKey && e.key === "Enter" && update()
      );
      els.textarea.addEventListener("input", () => update());
      els.textarea.addEventListener(
        "blur",
        () =>
          els.textarea.textContent === "" && (els.textarea.textContent = "")
      );

      els.dot.addEventListener("click", () => {
        setDot(!getDot());
        getText() ? update() : showAllExamples();
      });

      els.submit.addEventListener("click", () => update());
      els.prevExample.addEventListener("click", () =>
        showExample(state.currentExampleIndex - 1)
      );
      els.nextExample.addEventListener("click", () =>
        showExample(state.currentExampleIndex + 1)
      );
      els.allExamples.addEventListener("click", showAllExamples);
      els.buttonlog.addEventListener("click", () => {
        let a = els.log.classList.toggle("hidden");
        els.textarea.style.height = a ? "auto" : "100%";
        els.buttonlog.classList.toggle("off", a);
      });
      els.helpButton.addEventListener("click", () => (els.helpModal.style.display = "flex"));
      els.helpModal.addEventListener("click", (e) => e.target === els.helpModal && (els.helpModal.style.display = "none"));
      els.openStandalone.addEventListener("click", () =>
        openStandalone(getRulesObj())
      );
      els.downloadSvg.addEventListener("click", () =>
        downloadSvg(els.right.querySelector(":scope>svg"))
      );
      els.downloadPng.addEventListener("click", () =>
        downloadPng(els.right.querySelector(":scope>svg"))
      );
    }

    function setupMobile() {
      if (state.isMobile) els.log.classList.add("hidden");
    }

    function init() {
      setupCustomLog();
      setupDividers();
      setupMobileKeyboard();
      setupEventListeners();
      setupMobile();
      showAllExamples();
    }

    init();
  </script>
</body>

</html>
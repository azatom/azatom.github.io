<!DOCTYPE html>
<html dir="ltr" lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>L-System Fractals</title>
  <script src="lsystem.svg.js"></script>
  <script src="lsystem.examples.js"></script>

  <style>
    #left,
    #right {
      position: relative
    }

    #textarea,
    body,
    html,
    svg {
      height: 100%
    }

    #left,
    #textarea {
      box-sizing: border-box
    }

    #log,
    #textarea {
      padding: .5rem;
      white-space: pre-wrap;
      width: 100%;
      overflow: auto;
      font-family: monospace
    }

    #log,
    #textarea,
    svg {
      width: 100%
    }

    #butt,
    #left {
      gap: .5rem;
      display: flex
    }

    #helpText,
    #log,
    #right,
    #textarea {
      overflow: auto
    }

    #log,
    #textarea,
    .divaspre {
      font-family: monospace
    }

    #helpWindow,
    body,
    button,
    html {
      overflow: hidden
    }

    #butt,
    #left,
    #right,
    .smallsvgs,
    body,
    button.txt,
    html {
      display: flex
    }

    body,
    html {
      margin: 0;
      font-family: system-ui, sans-serif;
      flex-direction: row
    }

    #left {
      width: 16rem;
      min-width: 100px;
      max-width: 90vw;
      flex-direction: column;
      z-index: 1;
      background-color: #eee7
    }

    #right {
      flex: 1;
      justify-content: flex-start;
      align-items: flex-start;
      padding: 0;
      z-index: 0
    }

    svg {
      object-fit: contain;
      object-position: top left;
      display: block
    }

    #right>svg {
      cursor: zoom-out
    }

    #textarea {
      resize: vertical;
      border: none;
      background: #fff;
      min-height: 4rem;
      font-size: 1rem;
      word-break: break-all
    }

    #textarea>p::first-letter {
      font-weight: 900
    }

    #textarea>p {
      text-indent: -3.3ch;
      padding-left: 3.3ch;
      margin: .4rem 0;
      letter-spacing: .1ch;
      line-height: 1rem
    }

    #log {
      flex: 1;
      flex-basis: auto;
      font-size: .9rem;
      height: 9rem
    }

    #butt {
      align-items: center;
      flex: none;
      flex-wrap: wrap;
      user-select: none;
      padding: 0 .3rem .5rem .5rem
    }

    .dividerv:hover {
      cursor: col-resize
    }

    .dividerh:hover {
      cursor: row-resize
    }

    .divider {
      padding: .3rem;
      background-clip: content-box
    }

    .dividerv {
      width: 0;
      background: linear-gradient(to right, #f5f5f5 0, #f5f5f5 50%, #fff 50%, #fff 100%)
    }

    .dividerh {
      height: 0
    }

    .error {
      background: #d22
    }

    .smallsvgs {
      flex-wrap: wrap;
      flex-direction: row;
      align-content: flex-start
    }

    #helpModal,
    .hidden,
    button:hover>.a,
    button[data-checked]:hover>.b,
    button[data-checked]>.a {
      display: none
    }

    .smallsvgs>svg {
      width: calc(max(11vh, 11vw));
      height: calc(max(11vh, 11vw));
      cursor: pointer
    }

    #helpModal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .6);
      justify-content: center;
      align-items: center;
      z-index: 2
    }

    #helpWindow {
      background: #fff;
      padding: 1em;
      border-radius: 6px;
      box-shadow: 0 0 10px rgba(0, 0, 0, .3)
    }

    #helpText {
      max-height: 80vh;
      max-width: 84ch;
      font-size: 1rem
    }

    hr {
      border: none;
      border-top: .5px solid #ccc;
      max-width: 10rem;
      margin: 0 .25rem
    }

    .divaspre {
      white-space: pre;
      font-size: 1rem
    }

    .preasdiv,
    button.txt {
      font-family: sans-serif
    }

    .preasdiv {
      white-space: normal
    }

    button>object {
      pointer-events: none
    }

    button,
    button>object {
      height: 2rem;
      width: 2rem
    }

    button {
      color: #000;
      font-size: 1.2rem;
      border-radius: .3125rem;
      cursor: pointer;
      border: none;
      background-color: #ddd;
      line-height: 1;
      padding: 0
    }

    button:hover {
      background-color: #acf
    }

    button.off {
      color: #aaa
    }

    button.txt {
      align-items: center;
      font-weight: 100;
      justify-content: center;
      font-size: 1rem
    }

    button>.b {
      font-size: 2rem;
      display: none
    }

    button:hover>.b,
    button>.a,
    button[data-checked]:hover>.a,
    button[data-checked]>.b {
      display: block
    }

    div[contentEditable=true]:empty:not(:focus):before {
      font-family: sans-serif;
      font-style: italic;
      font-size: 1.2rem;
      content: attr(data-placeholder);
      color: #777
    }

    @media only screen and (max-width:600px) {

      #left,
      #right {
        height: auto;
        width: 100%
      }

      #butt,
      #log,
      #textarea {
        padding: .2rem
      }

      body,
      html {
        flex-direction: column
      }

      #left {
        max-width: 100%;
        padding: 0;
        gap: 0
      }

      #divider1,
      body.keyboard-active #butt,
      body.keyboard-active #log {
        display: none
      }

      #right {
        flex: 1
      }

      #textarea {
        height: 30vh
      }

      #log {
        max-height: 9rem
      }

      #butt {
        margin: 0;
        gap: .2rem
      }

      body.keyboard-active #left {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: 0 0;
        z-index: 2
      }

      body.keyboard-active #textarea {
        background: rgba(255, 255, 255, .9);
        position: relative;
        z-index: 3
      }

      body.keyboard-active #right {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1
      }
    }
  </style>
</head>

<body>
  <div id="left">
    <div id="textarea" data-placeholder="Type here S=FS+SF,_n=2 or click around. '>' shows next example" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contenteditable="true"></div>
    <div id="butt">
      <button id="helpButton" title="Help">?</button>
      <button id="buttonsubmit" title="Update (Ctrl+Enter)">‚ñ∂</button>
      <button id="prevExample" title="Previous example">&lt;</button>
      <button id="nextExample" title="Next example">&gt;</button>
      <button id="dot" title="Show endpoints only">
        <object class="a c" data="lsystem.js.svg?S=+++F++++F,_a=20,_b=fff0,_l=4,_M=2,_d=1" type="image/svg+xml">‚óè</object>
        <object class="b d" data="lsystem.js.svg?S=+++F++++F,_a=20,_b=0000,_l=4,_M=2" type="image/svg+xml">l</object>
      </button>
      <button id="allExamples" title="Show all examples">‚ú±</button>
      <button id="openStandalone" title="" class="txt">
        <div class="a">url</div>
        <div class="b">‚áó</div>
      </button>
      <button id="downloadSvg" title="" class="txt">
        <div class="a">svg</div>
        <div class="b">ü°á</div>
      </button>
      <button id="downloadPng" title="" class="txt">
        <div class="a">png</div>
        <div class="b">ü°á</div>
      </button>
      <button id="buttonlog" title="Toggle log">„èí</button>
      <div id="log"></div>
    </div>
  </div>
  <div class="divider dividerv" id="divider1"></div>
  <div id="right"></div>

  <div id="helpModal">
    <div id="helpWindow">
      <span onclick="document.querySelector('#helpModal').style.display='none'" style="float:right;cursor:pointer">X</span>
      <div id="helpText">
        <pre class="md">
## Logo Turtle with Context-Free Grammar - L-System Fractals

### How it Works:
Start with a sentence 'S'. Each iteration replaces
characters in the sentence using key-value rules.
The resulting sentence instructs a Logo turtle in
which direction, ho much go and draw or not its path.

### Syntax:
As ruleset can be in url fragment, queryparam, json
or plaintext:
- Rules separated by `,` or `&` or `\n`
- Rule's key-value separated by `=` or `:`

### Rule's key-value pairs:
Keys starting with `_` have numeric values:
- `_n`: Number of iterations
- `_l`: Initial line length (width=1)
- `_m`: Line length multiplier
- `_a`: Angle in degrees
- Single char: A rule
- Single char + `2`: Rule for n+1 iteration
- Empty key: Title

### Rule Value Characters:
- `S`: Starting sentence
- `F`, `f`: Move forward with/without drawing
- `+`, `-`, `^`, `|`: Rotate +a, -a, +90, 180
- `!`: Toggle rotation parity
- `*`, `/`: Multiply/divide line length by _m
- `[`, `]`: Push/pop position, length, direction

### Syntax
- Plaintext and url:
  - Rule separators: `,` or `&`. Plaintext: `\n` works too.
  - Key-value separator: `=`
- Url: preceed with `#` or `?` (fragment/queryparams)
- JSON: straightforward key-values

### Files
- `lsystem.js.svg`
  - embedable with `<object>` or `<embed>`, not with `<img>`.
  - browser can open as standalone image
- `lsystem.svg.js`
  - generates img capable plain svg
  - browser can not open as standalone image

### Some fibonacci:
```
 2;  2a(n-1)+a(n-2) 2,5,12,29,70,169,408,985,2378
 3;  4a(n-1)-a(n-2) 4,15,56,209,780,2911
 5;  4a(n-1)+a(n-2) 4,17,72,305,1292
 6; 10a(n-1)-a(n-2) 2,20,198,1960
 7; 16a(n-1)-a(n-2) 3,48,765
 8;  6a(n-1)-a(n-2) 6,35,204,1189
10;
```
        </pre>
      </div>
    </div>
  </div>

  <script type="module">
    const state = {
      examples: (typeof examples !== 'undefined' ? examples : [{
        S: 'AX',
        A: '[+AX-AX-AX]-AX+AX+AX-',
        F: '',
        X: 'F+F+F+FFF-F-F-F',
        _l: 2,
        _a: 60,
        _n: 3,
        '': 'tilesgLizard'
      }]).map(s => typeof s === 'string' ? parseRules(s) : s),
      currentExampleIndex: 0,
      isDividerActive: false,
      activeDivider: null,
      startX: 0,
      startY: 0,
      startWidth: 0,
      startHeight: 0,
      isMobile: /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
        typeof window.orientation !== 'undefined' ||
        (navigator.maxTouchPoints && navigator.maxTouchPoints > 1),
      lastViewportHeight: window.visualViewport ? window.visualViewport.height : window.innerHeight
    };

    const elements = {
      textarea: document.querySelector('#textarea'),
      log: document.querySelector('#log'),
      dot: document.querySelector('#dot'),
      right: document.querySelector('#right'),
      left: document.querySelector('#left'),
      submit: document.querySelector('#buttonsubmit'),
      divider1: document.querySelector('#divider1'),
      helpModal: document.querySelector('#helpModal'),
      helpButton: document.querySelector('#helpButton'),
      prevExample: document.querySelector('#prevExample'),
      nextExample: document.querySelector('#nextExample'),
      allExamples: document.querySelector('#allExamples'),
      buttonlog: document.querySelector('#buttonlog'),
      openStandalone: document.querySelector('#openStandalone'),
      downloadSvg: document.querySelector('#downloadSvg'),
      downloadPng: document.querySelector('#downloadPng'),
      message: Object.assign(document.createElement('div'), { textContent: 'generating...', style: 'font-size:2rem' })
    };

    function stringify(o) {
      return Object.entries(o).map(([k, v]) => `${k}=${v}`).join(',');
    }

    function getText() {
      return elements.textarea.innerText;
    }

    function setText(text) {
      return elements.textarea.innerText = text;
    }

    function setTextR(R) {
      return elements.textarea.innerHTML = Object.entries(R)
        .map(([k, v]) => `<p>${k.padStart(2, ' ')}=${v}</p>`)
        .join('');
    }

    function setDot(state) {
      elements.dot.toggleAttribute('data-checked', state);
    }

    function getDot() {
      return elements.dot.hasAttribute('data-checked');
    }

    function setupDividers() {
      const setDividering = e => {
        if (state.isMobile && e.target === elements.divider1) return;
        e.preventDefault();
        state.isDividerActive = true;
        state.activeDivider = e.target;
        state.startX = e.clientX;
        state.startY = e.clientY;
        state.startWidth = elements.left.offsetWidth;
        state.startHeight = elements.textarea.offsetHeight;
      };

      elements.divider1.addEventListener('pointerdown', setDividering);

      window.addEventListener('pointerup', () => {
        state.isDividerActive = false;
        state.activeDivider = null;
      });

      window.addEventListener('pointermove', e => {
        if (!state.isDividerActive || !state.activeDivider) return;
        if (state.activeDivider === elements.divider1 && !state.isMobile) {
          const deltaX = e.clientX - state.startX;
          const newWidth = state.startWidth + deltaX;
          elements.left.style.width = `${Math.min(Math.max(newWidth, 50), window.innerWidth - 50)}px`;
        }
      });
    }

    function setupMobileKeyboard() {
      if (!state.isMobile) return;

      function updateRightSize() {
        if (document.body.classList.contains('keyboard-active') && window.visualViewport) {
          elements.right.style.height = `${window.visualViewport.height}px`;
        } else {
          elements.right.style.height = 'auto';
        }
      }

      elements.textarea.addEventListener('focus', () => {
        document.body.classList.add('keyboard-active');
        updateRightSize();
      });

      elements.textarea.addEventListener('blur', () => {
        document.body.classList.remove('keyboard-active');
        elements.right.style.height = 'auto';
        elements.left.style.background = 'transparent';
      });

      if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', () => {
          if (Math.abs(window.visualViewport.height - state.lastViewportHeight) > 50) {
            document.body.classList.toggle('keyboard-active', window.visualViewport.height < state.lastViewportHeight);
            updateRightSize();
            state.lastViewportHeight = window.visualViewport.height;
          }
        });
      }
    }

    function parseRules(str) {
      return Object.fromEntries(
        str.replace(/&/g, ',')
          .replace(/([^,=]*)=([^,=]*)/g, '$1=$2')
          .split(',')
          .map(a => a.split('='))
      );
    }

    function getObject() {
      error();
      const R = getText()
        .replace(/[\n&]+/g, ',')
        .replace(/[\r \t\s\u00A0]+/g, '')
        .split(',')
        .filter(s => s !== '')
        .map(a => a.split('='));
      if (!R.every(([k, v]) =>
        /^(|[^=,]|_[^=,]|[^=,]2)$/.test(k) &&
        /[^=,]*/.test(v))
      ) {
        error('Invalid format');
        throw new Error('Invalid format');
      }
      return Object.fromEntries(R);
    }

    function error(msg) {
      elements.message.innerText = msg || '...';
      elements.submit.classList.toggle('error', !!msg);
      msg && elements.right.replaceChildren(elements.message);
    }

    async function update(rules) {
      if (rules) {
        //        setText(typeof rules === 'string'
        //          ? rules.replace(/,/g, '\n')
        //          : Object.entries(rules).map(([k, v]) => `${k}=${v}`).join('\n'));
        setTextR(typeof rules === 'string' ? parseRules(rules) : rules);
      }
      await new Promise(resolve => setTimeout(resolve, 0));
      error();
      try {
        const t0 = performance.now();
        const svg = createSvg(createR(getObject()));
        console.log({ [`${(performance.now() - t0) | 0}ms`]: state.currentExampleIndex ? `${state.currentExampleIndex + 1}/${state.examples.length} ${state.examples[state.currentExampleIndex]?.[''] || ''}` : '' });
        addSvgZoom(svg, '#right>svg');
        elements.right.replaceChildren(svg);
      } catch (e) {
        error(e.message + '\n' + e.stack);
      }
    }

    function createR(o, c) {
      let R = typeof o === 'string' ? parseRules(o) : o
        , dot = getDot() ? { _d: 1 } : {}
        , vb = elements.right.querySelector('svg');
      if (!c || !vb) return { ...R, ...dot };
      let v = vb.getAttribute('viewBox')?.split(' ') || []
        , rect = ['x', 'y', 'width', 'height'].map(attr => vb.querySelector('rect')?.getAttribute(attr));
      vb = v.length && rect.join(' ') !== v.join(' ')
        ? { _x: v[0], _y: v[1], _w: v[2], _h: v[3] }
        : {};
      return { ...R, ...dot, ...vb };
    }

    async function showExample(index) {
      state.currentExampleIndex = (index + state.examples.length) % state.examples.length;
      await update(state.examples[state.currentExampleIndex]);
    }

    async function showAllExamples() {
      const container = Object.assign(document.createElement('div'), { className: 'smallsvgs' });
      elements.right.replaceChildren(container);

      for (let i = 0; i < state.examples.length; i++) {
        const rules = Object.fromEntries(
          Object.entries(state.examples[i]).map(([k, v]) => [k, k === '_n' ? Math.max(2, v - 1) : v])
        );
        toggleCustomLog(false);
        const svg = createSvg(createR(rules));
        console.log({ [`#${i}`]: state.examples[i]?.[''] || '' });
        toggleCustomLog(true);
        svg.addEventListener('click', e => {
          if (e.shiftKey || e.ctrlKey) {
            openStandalone(state.examples[i]);
          } else {
            update(state.examples[i]);
          }
        });
        container.appendChild(svg);
        await new Promise(resolve => setTimeout(resolve, 0));
      }
    }

    function createIfAbsent(t, id) {
      return document.getElementById(id) ||
        document.body.appendChild(Object.assign(document.createElement(t), { id }));
    }

    function addSvgZoom(svg, cs) {
      let isDown = false;
      let startX, startY, scrollStartX, scrollStartY;
      const rip = CSS.escape('svgzoomr9fg34gs6h');
      const $rect = createIfAbsent('div', `${rip}rect`);
      $rect.style = 'position:absolute;pointer-events:none;display:none;';
      createIfAbsent('style', `${rip}css`).sheet.insertRule(`#${rip}rect>svg{cursor:zoom-out}`);

      const getXY = e => {
        const t = e.touches ? e.touches[0] || e.changedTouches[0] : e;
        return { x: t.pageX, y: t.pageY };
      };

      const start = e => {
        if (e.button) return;
        const p = getXY(e);
        startX = p.x;
        startY = p.y;
        scrollStartX = scrollX;
        scrollStartY = scrollY;
        isDown = true;
      };

      const move = e => {
        if (!isDown || e.button) return;
        const p = getXY(e);
        const out = p.x + scrollX - 2 < startX;
        $rect.style.cssText = `
          left:${Math.min(startX, p.x)}px;
          top:${Math.min(startY, p.y)}px;
          width:${Math.abs(p.x - startX)}px;
          height:${Math.abs(p.y - startY)}px;
          cursor:${out ? 'zoom-out' : 'zoom-in'};
          display:block;
          position:absolute;
          pointer-events:none;
          border:.2rem solid ${out ? '#e82' : '#17d'};
          background-color:${out ? '#e823' : '#17d3'};
        `;
      };

      const end = e => {
        if (!isDown) return;
        const p = getXY(e);
        const r = svg.getBoundingClientRect();
        const v = svg.getAttribute('viewBox').split(' ').map(parseFloat);
        const x1 = v[0] + v[2] * (startX + scrollStartX - r.left) / r.width;
        const y1 = v[1] + v[3] * (startY + scrollStartY - r.top) / r.height;
        const x2 = v[0] + v[2] * (p.x + scrollX - r.left) / r.width;
        const y2 = v[1] + v[3] * (p.y + scrollY - r.top) / r.height;
        if (p.x + scrollX - 2 < startX + scrollStartX) {
          svg.setAttribute('viewBox', `${v[0] - v[2]} ${v[1] - v[3]} ${3 * v[2]} ${3 * v[3]}`);
        } else {
          svg.setAttribute('viewBox', `${x1} ${Math.min(y1, y2)} ${x2 - x1} ${Math.abs(y2 - y1)}`);
        }
        isDown = false;
        $rect.style.display = 'none';
        svg.style.cursor = 'zoom-out';
      };

      ['mousedown', 'touchstart'].forEach(e => svg.addEventListener(e, start));
      ['mousemove', 'touchmove'].forEach(e => svg.addEventListener(e, move));
      ['mouseup', 'touchend', 'touchcancel'].forEach(e => svg.addEventListener(e, end));
      return svg;
    }

    function openStandalone(o) { window.open(`lsystem.js.svg#${stringify(createR(o, 1))}`, '_blank').focus(); };

    function setupEventListeners() {
      elements.textarea.addEventListener('keydown', e => e.ctrlKey && e.key === 'Enter' && update());
      elements.textarea.addEventListener('input', () => update());
      elements.textarea.addEventListener('blur', () => elements.textarea.textContent === '' && (elements.textarea.textContent = ''));
      elements.dot.addEventListener('click', () => {
        setDot(!getDot()); console.error('click');
        if (getText()) update(); else showAllExamples();
      });
      elements.submit.addEventListener('click', () => update());
      elements.prevExample.addEventListener('click', () => showExample(state.currentExampleIndex - 1));
      elements.nextExample.addEventListener('click', () => showExample(state.currentExampleIndex + 1));
      elements.allExamples.addEventListener('click', showAllExamples);
      elements.buttonlog.addEventListener('click', () => {
        elements.textarea.style.height = '100%';
        elements.log.classList.toggle('hidden');
        elements.buttonlog.classList.toggle('off');
      });
      elements.helpButton.addEventListener('click', () => elements.helpModal.style.display = 'flex');
      elements.helpModal.addEventListener('click', e => e.target === elements.helpModal && (elements.helpModal.style.display = 'none'));
      elements.openStandalone.addEventListener('click', () => openStandalone(getObject()));
      elements.downloadSvg.addEventListener('click', () => downloadSvg(elements.right.querySelector(':scope>svg')));
      elements.downloadPng.addEventListener('click', () => downloadPng(elements.right.querySelector(':scope>svg')));
    }

    function toggleCustomLog(enable, customLog, _ = console) {
      if ('function' == typeof customLog) {
        _.oldLog ||= _.log;
        _.customLog = customLog;
        _.log = _.customLog;
      }
      if (_.oldLog && _.customLog) _.log = enable ? _.customLog : _.oldLog;
    }

    function setupCustomLog() {
      toggleCustomLog(true, (...args) => elements.log ? (
        elements.log.prepend(document.createElement('hr')),
        elements.log.prepend(args
          .flatMap(a => typeof a === 'object' ? Object.entries(a) : [['', a]])
          .map(([k, v]) => `${k.padStart(3, ' ')} ${v}`)
          .join('\n')
        )
      ) : console.oldLog(...args));
    }
    function setupMobile() { if (state.isMobile) elements.log.classList.add('hidden'); }

    const downloadPng = async (svg) => {
    };
    const downloadSvg = async (svg) => {
      if (!svg) return;
      const downloadBlob = async (blob, filename) => {
        const url = URL.createObjectURL(blob);
        try {
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        } finally {
          setTimeout(() => URL.revokeObjectURL(url), 100);
        }
      };
      const xmlString = new XMLSerializer().serializeToString(svg);
      const uint8Array = new TextEncoder().encode(xmlString);
      await downloadBlob(
        new Blob([uint8Array], { type: 'image/svg+xml' }),
        `${svg.querySelector('title')?.textContent ?? 'untitled'}.svg`
      );
    };

    function init() {
      setupCustomLog();
      setupDividers();
      setupMobileKeyboard();
      setupEventListeners();
      setupMobile();
      if (0) showExample(2); else showAllExamples();
    }

    init();
  </script>
</body>

</html>